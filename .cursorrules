# 代码规范与最佳实践

## 核心原则

### 1. SOLID 原则（必须严格遵守）

#### 单一职责原则 (SRP)
- 每个类/函数只负责一个功能
- 修改某个功能时，只需要修改一个地方
- 服务层、控制器层、数据访问层职责明确分离

#### 开放封闭原则 (OCP)
- 对扩展开放，对修改封闭
- 使用接口和抽象类来实现可扩展性
- 新增功能时不修改现有代码，而是通过扩展实现

#### 里氏替换原则 (LSP)
- 子类必须能够替换父类
- 继承时不改变父类的行为约定
- 保持接口契约的一致性

#### 接口隔离原则 (ISP)
- 客户端不应依赖它不需要的接口
- 将大接口拆分为多个小接口
- 避免"胖"接口导致的不必要依赖

#### 依赖倒置原则 (DIP)
- 高层模块不依赖低层模块，都依赖抽象
- 抽象不依赖细节，细节依赖抽象
- 使用依赖注入来解耦

### 2. DRY 原则（Don't Repeat Yourself）

#### 代码重复处理
- **3次重复规则**：代码出现3次及以上必须提取封装
- **相似逻辑**：超过80%相似的代码必须抽象为通用函数
- **配置重复**：重复的配置项提取到常量文件
- **类型重复**：重复的类型定义提取到 types 目录

#### 封装层次
```
utils/      - 纯函数工具类（无副作用）
services/   - 业务逻辑服务（可复用的业务逻辑）
middleware/ - 中间件（请求处理的通用逻辑）
constants/  - 常量定义（配置、枚举、固定值）
types/      - 类型定义（接口、类型别名）
```

### 3. 重构安全原则（零影响重构）

#### 重构前提条件
- **必须有测试覆盖**：没有测试的代码不允许重构
- **保持接口不变**：公开的 API 接口签名不能改变
- **渐进式重构**：大规模重构必须分步进行，每步可独立验证
- **向后兼容**：重构后的代码必须与旧版本兼容

#### 重构验证清单
- [ ] 所有现有测试通过
- [ ] 接口签名保持不变
- [ ] 输入输出行为一致
- [ ] 性能无明显下降
- [ ] 错误处理逻辑保持一致

#### 禁止的重构行为
- ❌ 在重构同时添加新功能
- ❌ 修改公开 API 的行为
- ❌ 删除现有功能（即使未使用）
- ❌ 大规模一次性重构（超过5个文件）

## TypeScript 最佳实践

### 类型安全
- 禁止使用 `any`，使用 `unknown` 代替
- 所有函数参数和返回值必须有类型注解
- 使用严格的 TypeScript 配置（`strict: true`）
- 接口优先于类型别名（对于对象结构）

### 命名规范
- **文件名**：kebab-case（如：`user-service.ts`）
- **类名**：PascalCase（如：`UserService`）
- **函数/变量**：camelCase（如：`getUserById`）
- **常量**：UPPER_SNAKE_CASE（如：`MAX_RETRY_COUNT`）
- **接口**：PascalCase，不使用 `I` 前缀（如：`User`，不是 `IUser`）
- **类型别名**：PascalCase（如：`UserRole`）

### 错误处理
- 使用自定义错误类而非抛出字符串
- 所有异步操作必须有错误处理
- 使用统一的错误响应格式
- 记录错误日志时包含上下文信息

## 项目特定规范

### API 层规范
- 控制器只做参数验证和响应组装，不包含业务逻辑
- 业务逻辑必须在 Service 层实现
- 路由定义集中在 routes 目录
- 中间件保持单一职责

### 数据库操作
- 使用 Prisma Client 进行数据库操作
- 不在控制器中直接操作数据库
- 复杂查询封装在 Service 层
- 使用事务处理关联操作

### 前端组件规范
- 组件单一职责，不超过 300 行
- 状态管理使用 Pinia
- API 调用封装在 api 目录
- 组件通信优先使用 props/emit

### 安全规范
- 所有用户输入必须验证
- 敏感信息不能记录到日志
- 使用环境变量管理配置
- API 接口必须有认证鉴权

## 代码审查要点

### 必查项
1. 是否遵循 SOLID 原则
2. 是否有重复代码
3. 是否影响现有功能
4. 类型定义是否完整
5. 错误处理是否完善
6. 命名是否规范

### 优化建议
- 性能敏感的代码添加性能测试
- 复杂逻辑添加注释说明
- 公开 API 添加 JSDoc 文档
- 边界情况的处理

## 提交规范

### Commit Message 格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type 类型：**
- `feat`: 新功能
- `fix`: 修复 bug
- `refactor`: 重构（不改变功能）
- `perf`: 性能优化
- `style`: 代码格式调整
- `docs`: 文档更新
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例：**
```
feat(user): 添加用户注册功能

- 实现用户注册接口
- 添加邮箱验证
- 添加密码强度检查

Closes #123
```

## 性能优化原则

- 避免 N+1 查询问题
- 合理使用缓存（Redis）
- 大数据量使用分页
- 异步操作使用队列
- 静态资源使用 CDN

## 测试要求

- 核心业务逻辑必须有单元测试
- API 接口必须有集成测试
- 测试覆盖率不低于 70%
- 重构前后测试必须通过

