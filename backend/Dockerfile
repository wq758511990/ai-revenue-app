# ============================================
# Stage 1: æ„å»ºé˜¶æ®µ
# ============================================
FROM node:18-slim AS builder

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆè¿™ä¸€å±‚ä¼šè¢«ç¼“å­˜ï¼‰
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ package æ–‡ä»¶ï¼ˆå•ç‹¬ä¸€å±‚ï¼Œä¾¿äºç¼“å­˜ï¼‰
COPY package*.json ./

# å®‰è£…ä¾èµ–ï¼ˆè¿™ä¸€å±‚ä¹Ÿä¼šè¢«ç¼“å­˜ï¼‰
RUN npm ci

# å¤åˆ¶ Prisma schema
COPY prisma ./prisma/

# ç”Ÿæˆ Prisma Client
RUN npx prisma generate

# å¤åˆ¶æºä»£ç 
COPY src ./src/
COPY tsconfig.json ./

# ç¼–è¯‘ TypeScript
RUN npm run build

# ============================================
# Stage 2: ç”Ÿäº§è¿è¡Œé˜¶æ®µï¼ˆæ›´å°çš„é•œåƒï¼‰
# ============================================
FROM node:18-slim

WORKDIR /app

# åªå®‰è£…è¿è¡Œæ—¶å¿…éœ€çš„ä¾èµ–
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
    openssl \
    ca-certificates \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶å¿…è¦æ–‡ä»¶
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/prisma ./prisma/

# éªŒè¯æ„å»º
RUN echo "=== éªŒè¯æ–‡ä»¶ ===" && \
    ls -la /app/dist/ && \
    test -f /app/dist/app.js && echo "âœ… app.js å­˜åœ¨" || echo "âŒ app.js ä¸å­˜åœ¨"

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨è„šæœ¬
CMD ["sh", "-c", "set -e && \
    echo '=== ç¯å¢ƒå˜é‡æ£€æŸ¥ ===' && \
    echo \"NODE_ENV: $NODE_ENV\" && \
    echo \"PORT: $PORT\" && \
    echo \"DATABASE_URL: ${DATABASE_URL:0:30}...\" && \
    echo \"JWT_SECRET: ${JWT_SECRET:0:10}...\" && \
    echo '' && \
    echo 'ğŸ”„ Running database migrations...' && \
    npx prisma migrate deploy && \
    echo 'ğŸŒ± Seeding database...' && \
    npx prisma db seed && \
    echo 'ğŸš€ Starting application...' && \
    exec node dist/app.js"]

