# åç«¯ Dockerfile
# ä½¿ç”¨ Debian-slim åŸºç¡€é•œåƒï¼ˆPrisma éœ€è¦ OpenSSL æ”¯æŒï¼‰
FROM node:18-slim

WORKDIR /app

# å®‰è£… OpenSSL å’Œå…¶ä»–å¿…è¦ä¾èµ–
RUN apt-get update -y && \
    apt-get install -y openssl ca-certificates curl wget procps && \
    rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ package æ–‡ä»¶
COPY package*.json ./
COPY prisma ./prisma/

# å®‰è£…ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼Œå› ä¸ºéœ€è¦ TypeScript å’Œ ts-nodeï¼‰
RUN npm install

# å¤åˆ¶æºä»£ç 
COPY . .

# ç”Ÿæˆ Prisma Client
RUN npx prisma generate

# ç¼–è¯‘ TypeScript
RUN npm run build

# éªŒè¯æ„å»ºè¾“å‡º
RUN echo "=== æ£€æŸ¥ç¼–è¯‘ç»“æœ ===" && \
    ls -la /app/ && \
    echo "=== dist ç›®å½•å†…å®¹ ===" && \
    ls -la /app/dist/ && \
    echo "=== æŸ¥æ‰¾ app.js ===" && \
    find /app/dist -name "app.js" -type f

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨è„šæœ¬
CMD ["sh", "-c", "set -e && \
    echo '=== ç¯å¢ƒå˜é‡æ£€æŸ¥ ===' && \
    echo \"NODE_ENV: $NODE_ENV\" && \
    echo \"PORT: $PORT\" && \
    echo \"DATABASE_URL: ${DATABASE_URL:0:30}...\" && \
    echo \"JWT_SECRET: ${JWT_SECRET:0:10}...\" && \
    echo '' && \
    echo 'ğŸ”„ Running database migrations...' && \
    npx prisma migrate deploy && \
    echo 'ğŸŒ± Seeding database...' && \
    npx prisma db seed && \
    echo 'ğŸš€ Starting application...' && \
    exec node dist/app.js"]

