# syntax=docker/dockerfile:1.4
# ============================================
# Alpine ç‰ˆæœ¬ï¼ˆé•œåƒæ›´å°ï¼Œæ„å»ºæ›´å¿«ï¼‰
# ============================================
FROM node:18-alpine AS builder

WORKDIR /app

# å®‰è£…æ„å»ºä¾èµ–ï¼ˆAlpine ä½¿ç”¨ apkï¼‰
RUN apk add --no-cache \
    openssl \
    libc6-compat

# é…ç½® npm å’Œ pnpm ä½¿ç”¨å›½å†…é•œåƒ
RUN npm config set registry https://registry.npmmirror.com && \
    npm install -g pnpm && \
    pnpm config set registry https://registry.npmmirror.com

# å¤åˆ¶ package æ–‡ä»¶
COPY package.json pnpm-lock.yaml ./

# å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ BuildKit ç¼“å­˜ï¼‰
RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
    pnpm install --frozen-lockfile

# å¤åˆ¶ Prisma schema
COPY prisma ./prisma/

# ç”Ÿæˆ Prisma Client
RUN npx prisma generate

# å¤åˆ¶æºä»£ç 
COPY src ./src/
COPY tsconfig.json ./

# ç¼–è¯‘ TypeScript
RUN npm run build

# ç¼–è¯‘ seed è„šæœ¬
RUN npx tsc prisma/seed.ts --outDir prisma --module commonjs --esModuleInterop

# ============================================
# ç”Ÿäº§è¿è¡Œé˜¶æ®µ
# ============================================
FROM node:18-alpine

WORKDIR /app

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    openssl \
    curl \
    ca-certificates \
    libc6-compat

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ–‡ä»¶
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/prisma ./prisma/

# éªŒè¯æ„å»º
RUN echo "=== éªŒè¯æ–‡ä»¶ ===" && \
    ls -la /app/dist/ && \
    test -f /app/dist/app.js && echo "âœ… app.js å­˜åœ¨" || echo "âŒ app.js ä¸å­˜åœ¨"

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# å¯åŠ¨è„šæœ¬
CMD ["sh", "-c", "set -e && \
    echo '=== ç¯å¢ƒæ£€æŸ¥ ===' && \
    echo \"NODE_ENV: $NODE_ENV\" && \
    echo \"PORT: $PORT\" && \
    echo 'DATABASE_URL: configured' && \
    echo 'JWT_SECRET: configured' && \
    echo '' && \
    echo 'ğŸ”„ Running database migrations...' && \
    npx prisma migrate deploy && \
    echo 'ğŸŒ± Seeding database...' && \
    (node prisma/seed.js 2>/dev/null || npx prisma db seed || echo 'âš ï¸ Seed skipped') && \
    echo 'ğŸš€ Starting application...' && \
    exec node dist/app.js"]

